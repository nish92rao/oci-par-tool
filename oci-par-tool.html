<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
		
	<script type="text/javascript">
		var parUrl;
		var fileUrlMap;
		
		function generateDownloadFromBlob(blob,fileName){
			const a = document.createElement("a");
			a.href = URL.createObjectURL(blob);
			a.download = fileName;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
		}
		
		function getUrlMap(url, fileArr){
			var result = new Map();
			fileArr.forEach(fileObj => {
				var fileName = fileObj.name;
				var fileUrl = url + fileName;
				result.set(fileName,fileUrl);
			});
			return result;
		}
		
		async function getFileBlobMap(urlMap){
			var result = new Map();
			var promiseArr = new Array();
			urlMap.forEach((fileUrl,fileName) => {
				var fileBlobPromise = fetch(fileUrl).then(resp => resp.blob());
				promiseArr.push(fileBlobPromise);
			});
			var blobArr = await Promise.all(promiseArr);
			var count = 0;
			urlMap.forEach((fileUrl,fileName) => {
				result.set(fileName,blobArr[count++]);
			});
			return result;
		}
		
		async function downloadZipFile(fileBlobMap){
			const zip = new JSZip();
			fileBlobMap.forEach((fileBlob,fileName) => {
				zip.file(fileName,fileBlob);
			});
			zip.generateAsync({type: 'blob'}).then(zipBlob => {
				generateDownloadFromBlob(zipBlob,"zipfile.zip");
			});
			
		}
		
		function showFileList(urlMap) {
			var table = document.getElementById("files").children[0];
			urlMap.forEach((fileUrl,fileName) => {
				var fileNameParts = fileName.split("/");
				if(fileNameParts[fileNameParts.length-1]!=""){
					//create table row
					var tr = document.createElement("tr");
					tr.id=fileName;
					
					//create cell for file name
					var d1 = document.createElement("td");
					d1.innerHTML = fileName;
					tr.appendChild(d1);
					
					//create download button for object
					var button = document.createElement("button");
					button.type = "button";
					button.innerHTML = "Download";
					button.onclick = function(){download(fileUrl)};
					
					//create cell for file download button
					var d2 = document.createElement("td");
					d2.appendChild(button);
					tr.appendChild(d2);
					
					//add row to the table
					table.appendChild(tr);
				} else {
				}
			});
		}
		
		
		async function download(url) {
			fileUrlMap = new Map();
			
			var urlArr = url.split("/o");
			var fileName = urlArr[urlArr.length - 1];
			
			if(fileName[0]=='/'){
				fileName = fileName.substr(1);
			}
			
			try{
				const res = await fetch(url);
				
				if(fileName != ""){
					var blob = await res.blob();
					var fileNameParts = fileName.split("/");
					fileName = fileNameParts[fileNameParts.length-1]
					generateDownloadFromBlob(blob,fileName);
				} else {
					var jsonFileList = await res.json();
					if(jsonFileList.objects.length > 0){
						parUrl = url;
						fileUrlMap = getUrlMap(url,jsonFileList.objects);
						document.getElementById("url").disabled="true";
						document.getElementById("download").disabled="true";
						document.getElementById("multi").style="display:block";
						showFileList(fileUrlMap);
					}				
				}				
			} catch (e) { console.log(e); }
		}
		
		async function downloadAll() {
			if(parUrl != null && parUrl != undefined && parUrl != ""){
				var fileBlobMap = await getFileBlobMap(fileUrlMap);
				await downloadZipFile(fileBlobMap);
			}
		}
		
		function changeUrl(){
			parUrl = "";
			fileUrlMap = new Map();
			var trArr = document.getElementById("files").children[0].children;
			while(trArr.length!=1){
				trArr[1].remove();
			}
			document.getElementById("multi").style="display:none";
			document.getElementById("url").value="";
			document.getElementById("url").disabled="";
			document.getElementById("download").disabled="";
		}
		
	</script>
</head>
<body>
	<div id="main">
		<h1>OCI Object Storage PAR Download Tool</h1>
		<br>
		This is a web tool for downloading multiple files shared via a Pre-Authenticated Request (PAR) for an OCI Object Storage Bucket.
		<br>
		More information about PAR <a href="https://objectstorage.us-phoenix-1.oraclecloud.com/p/1SDrt_SFkzzHwoVIXpO2aScxotXF0Pd2MIvKdCp8f1BysorLfxJQmXm9zyGfBsKH/n/axdvjzox0ixb/b/nishraobucket/o/">here</a>.
		<br><br>
		To use this tool, please note that: <br>
		<ul>
			<li>this tool works only with PAR generated by Oracle Cloud Infrastructure (OCI) Object Storage Service.</li>
			<li>the PAR URL can be for a single object or multiple objects.</li>
			<li>the PAR URL <b>must</b> allow Object Listing if meant for multiple objects.</li>
			<li>only download operation can be performed using this tool.</li>
		</ul>
		<br>
		Enter URL for download here: 
		<input type="text" id="url"/>
		&nbsp; &nbsp;
		<button type="button" id="download" onclick="download(document.getElementById('url').value)">Download!</button>
		<br><br><br>
		<div id="multi" style="display:none">
			This PAR URL allows for download of multiple files. You may either download all files by clicking the "Download All" button, or download files individually from the list.
			<br>
			<button type="button" id="download-all" onclick="downloadAll()">Download All</button>
			&nbsp;
			<button type="button" id="change-url" onclick="changeUrl()">Change URL</button>
			<br><br>
			<div id="file-list">
				<table id="files" border="1" width="90%">
					<tr id="header">
						<th width="80%">File Name</th>
						<th width="20%">Download</th>
					</tr>
				</table>
			</div>
		</div>
	</div>
</body>
</html>